#
# Copyright (c) 2021-2025 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#

name: Pull Request Check

# Trigger the workflow on pull request
on: [pull_request]

env:
  # Use repository variable if set, otherwise fallback to default registry
  REGISTRY: ${{ vars.REGISTRY || 'quay.io/devfile' }}

jobs:
  build-base-image:
    name: Build base image
    strategy:
      fail-fast: false
      matrix:
        runners: ['ubuntu-22.04', 'ubuntu-22.04-arm']
    runs-on: ${{matrix.runners}}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Debug Registry Configuration
        run: |
          echo "üîç Registry Configuration Debug:"
          echo "Repository Variable (vars.REGISTRY): '${{ vars.REGISTRY }}'"
          echo "Resolved REGISTRY env var: '${{ env.REGISTRY }}'"
          echo "GitHub Repository: ${{ github.repository }}"
          echo "Repository Owner: ${{ github.repository_owner }}"
          if [ "${{ vars.REGISTRY }}" != "" ]; then
            echo "‚úÖ Using custom registry from repository variable"
          else
            echo "‚ö†Ô∏è  Using fallback registry (no custom REGISTRY variable set)"
          fi
      - name: Set arch environment variable
        run: |
          if [[ ${{matrix.runners}} == 'ubuntu-22.04' ]]; then
            echo arch="amd64" >> $GITHUB_ENV
          else
            echo arch="arm64" >> $GITHUB_ENV
          fi
      - name: Free runner space
        run: sudo rm -rf /usr/local/lib/android
      - name: Cleanup docker images
        run: docker system prune -af
      - name: Build base image
        run: |
            cd base/ubi9 && docker buildx build \
            --platform linux/${{env.arch}} \
            --progress=plain \
            -t base-developer-image-${{env.arch}} .
      - name: Display docker images
        run: docker images
      - name: Compress image to a file
        run: docker save base-developer-image-${{env.arch}} | gzip > base-developer-image-${{env.arch}}.tgz
      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: base-developer-image-${{env.arch}}
          path: base-developer-image-${{env.arch}}.tgz

  build-udi:
    name: Build udi
    strategy:
      fail-fast: false
      matrix:
        runners: ['ubuntu-22.04', 'ubuntu-22.04-arm']
    runs-on: ${{matrix.runners}}
    needs: build-base-image
    steps:
      - name: Set arch environment variable
        run: |
          if [[ ${{matrix.runners}} == 'ubuntu-22.04' ]]; then
            echo arch="amd64" >> $GITHUB_ENV
          else
            echo arch="arm64" >> $GITHUB_ENV
          fi
      - name: Checkout
        uses: actions/checkout@v4
      - name: Debug Registry Configuration (UDI)
        run: |
          echo "üîç UDI Registry Configuration Debug:"
          echo "Repository Variable (vars.REGISTRY): '${{ vars.REGISTRY }}'"
          echo "Resolved REGISTRY env var: '${{ env.REGISTRY }}'"
          echo "GitHub Repository: ${{ github.repository }}"
          echo "Target registry for UDI: ${{ env.REGISTRY }}/universal-developer-image"
      - name: Free runner space
        run: sudo rm -rf /usr/local/lib/android
      - name: Cleanup docker images
        run: docker system prune -af
      - name: Download BDI artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: base-developer-image-*
          merge-multiple: true
          path: .
      - name: List downloaded files
        run: ls -lah
      - name: Load docker images
        run: docker load -i base-developer-image-${{env.arch}}.tgz
      - name: Display docker images
        run: docker images
      - name: Update UDI Dockerfile
        run: sed "s|quay.io/devfile/base-developer-image:ubi9-latest|base-developer-image-${{env.arch}}|" -i "universal/ubi9/Dockerfile"
      - name: Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}
      - name: Build udi
        run: |
          cd universal/ubi9 && docker buildx build \
            --platform linux/${{env.arch}} \
            --progress=plain \
            --push \
            -t ${{ env.REGISTRY }}/universal-developer-image:${{env.arch}}-pr-${{github.event.number}} .

  publish-udi:
    name: Publish udi
    runs-on: ubuntu-22.04
    needs: build-udi
    steps:
      - name: Debug Registry Configuration (UDI)
        run: |
          echo "üîç UDI Registry Configuration Debug:"
          echo "Repository Variable (vars.REGISTRY): '${{ vars.REGISTRY }}'"
          echo "Resolved REGISTRY env var: '${{ env.REGISTRY }}'"
          echo "GitHub Repository: ${{ github.repository }}"
          echo "Target registry for UDI: ${{ env.REGISTRY }}/universal-developer-image"
      - name: Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}
      - name: publish
        run: |
          docker manifest create ${{ env.REGISTRY }}/universal-developer-image:pr-${{github.event.number}} \
            --amend ${{ env.REGISTRY }}/universal-developer-image:amd64-pr-${{github.event.number}} \
            --amend ${{ env.REGISTRY }}/universal-developer-image:arm64-pr-${{github.event.number}}         
          
          docker manifest annotate ${{ env.REGISTRY }}/universal-developer-image:pr-${{github.event.number}} \
            ${{ env.REGISTRY }}/universal-developer-image:amd64-pr-${{github.event.number}} \
            --os linux --arch amd64
          docker manifest annotate ${{ env.REGISTRY }}/universal-developer-image:pr-${{github.event.number}} \
            ${{ env.REGISTRY }}/universal-developer-image:arm64-pr-${{github.event.number}} \
            --os linux --arch arm64
           
          docker manifest push ${{ env.REGISTRY }}/universal-developer-image:pr-${{github.event.number}}
      - name: 'Comment PR'
        uses: actions/github-script@v7
        with:
          script: |
            const { repo: { owner, repo } } = context;
            await github.rest.issues.createComment({
               issue_number: ${{github.event.number}},
               owner: context.repo.owner,
               repo: context.repo.repo,
               body: `Pull Request images published ‚ú®\n\nUDI: [${{ env.REGISTRY }}/universal-developer-image:pr-${{github.event.number}}](https://${{ env.REGISTRY }}/universal-developer-image:pr-${{github.event.number}})`
             })
